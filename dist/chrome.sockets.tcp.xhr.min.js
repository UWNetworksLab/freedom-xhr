/*!
 * chrome.sockets.tcp.xhr v0.0.2 (https://github.com/codeinchaos/chrome.sockets.tcp.xhr)
 * Copyright 2014 Ahmad Nassri <ahmad@codeinchaos.com> (http://ahmadnassri.com)
 * Licensed under MIT License
 */

!function(){"use strict";var a=chrome.sockets.tcp.xhr=function(){Object.defineProperties(this,{options:{enumerable:!1,writable:!0,value:{uri:null,data:null,events:{},method:null,createInfo:null,inprogress:!1,redirects:{max:10,current:0,last:null},timer:{id:null,expired:!1},headers:{Connection:"close","Accept-Encoding":"identity","Content-Length":0},response:{headers:[],headersText:null}}},props:{enumerable:!1,configurable:!1,value:{readyState:0}},UNSENT:{enumerable:!1,writable:!0,value:0},OPENED:{enumerable:!1,writable:!0,value:1},HEADERS_RECEIVED:{enumerable:!1,writable:!0,value:2},LOADING:{enumerable:!1,writable:!0,value:3},DONE:{enumerable:!1,writable:!0,value:4},timeout:{enumerable:!0,writable:!0,value:0},withCredentials:{enumerable:!0,writable:!0,value:!1},upload:{enumerable:!0,writable:!0,value:null},status:{enumerable:!0,writable:!0,value:0},statusText:{enumerable:!0,writable:!0,value:null},responseType:{enumerable:!0,writable:!0,value:"text"},response:{enumerable:!0,writable:!0,value:null},responseText:{enumerable:!0,writable:!0,value:null},responseXML:{enumerable:!0,writable:!0,value:null},onreadystatechange:{enumerable:!0,writable:!0,value:null},ontimeout:{enumerable:!0,writable:!0,value:null},onabort:{enumerable:!0,writable:!0,value:null},onerror:{enumerable:!0,writable:!0,value:null},onload:{enumerable:!0,writable:!0,value:null},onloadstart:{enumerable:!0,writable:!0,value:null},onloadend:{enumerable:!0,writable:!0,value:null},onprogress:{enumerable:!0,writable:!0,value:null},beforeredirect:{enumerable:!0,writable:!0,value:null},readyState:{enumerable:!0,get:function(){return this.props.readyState},set:function(a){this.props.readyState=a,this.dispatchEvent("readystatechange")}}})};a.prototype.regex=new RegExp("^(?:(https?|ftp)://)(?:\\S+(?::\\S*)?@)?((?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))(?::(\\d{2,5}))?(/[^\\s]*)?$","i"),a.prototype.open=function(a,b){if(this.options.method=a,this.options.uri=this.regex.exec(b),!this.options.method)throw new TypeError("method is not a valid HTTP method");if(null===this.options.uri)throw new TypeError("url cannot be parsed");this.readyState=this.OPENED,this.setRequestHeader("Host",this.options.uri[2])},a.prototype.setRequestHeader=function(a,b){if(this.readyState!==this.OPENED||this.options.inprogress===!0)throw new TypeError("InvalidStateError");if(!a)throw new TypeError("header is not a valid HTTP header field name");if(!b&&0!==b.length)throw new TypeError("value is not a valid HTTP header field value.");this.options.headers[a]=b},a.prototype.send=function(a){if(this.readyState!==this.OPENED||this.options.inprogress===!0)throw new TypeError("InvalidStateError");if(-1!==["GET","HEADER"].indexOf(this.options.method.toUpperCase())&&(a=null),null!==a){var b=null,c=null;a instanceof ArrayBufferView||a instanceof Blob||(a instanceof HTMLElement?(b="UTF-8",c="text/html",c+=";charset=UTF-8"):a instanceof FormData||"string"==typeof a&&(b="UTF-8",c="text/plain;charset=UTF-8")),this.options.data=a}this.options.inprogress=!0,this.dispatchEvent("loadstart");var d={persistent:!1,name:"chrome.sockets.tcp.xhr"};chrome.sockets.tcp.create(d,this.onCreate.bind(this)),this.timeout>0&&(this.options.timer.id=setTimeout(this.expireTimer.bind(this),this.timeout))},a.prototype.abort=function(){this.disconnect()},a.prototype.getResponseHeader=function(a){return this.options.response.headers[a]},a.prototype.getAllResponseHeaders=function(){return this.options.response.headersText},a.prototype.overrideMimeType=function(){},a.prototype.addEventListener=function(a,b){return this.options.events[a]?this.options.events[a].push(b):this.options.events[a]=new Array(b),this},a.prototype.removeEventListener=function(a,b){if(this.options.events[a]){var c=this.options.events[a].indexOf(b);return c>-1?(this.options.events[a].splice(c,1),!0):!1}return!1},a.prototype.dispatchEvent=function(a){var b=arguments;return this.hasOwnProperty("on"+a)&&this["on"+a]&&this["on"+a].apply(this,Array.prototype.slice.call(b,1)),this.options.events[a]?void this.options.events[a].forEach(function(a){a.apply(this,Array.prototype.slice.call(b,1))}.bind(this)):!1},a.prototype.onCreate=function(a){if(this.options.inprogress){var b=this.options.uri[3]?parseInt(this.options.uri[3],null):80;this.options.createInfo=a,chrome.sockets.tcp.connect(a.socketId,this.options.uri[2],b,this.onConnect.bind(this))}},a.prototype.onConnect=function(a){this.options.inprogress&&(this.options.timer.expired||(0>a?this.error({error:"connect error",resultCode:a}):(chrome.sockets.tcp.onReceive.addListener(this.onReceive.bind(this)),this.generateMessage().toArrayBuffer(function(a){chrome.sockets.tcp.send(this.options.createInfo.socketId,a,this.onSend.bind(this))}.bind(this)))))},a.prototype.onSend=function(a){a.resultCode<0&&(this.error({error:"send error",resultCode:a.resultCode}),this.disconnect())},a.prototype.onReceiveError=function(a){this.error({error:"receive error",resultCode:a.resultCode})},a.prototype.onReceive=function(a){this.options.inprogress&&a.socketId===this.options.createInfo.socketId&&(this.disconnect(),a.data.toString(this.parseResponse.bind(this)))},a.prototype.parseResponse=function(a){var b=a.match(/\r\n\r\n/);if(null===b)return void this.error({error:"could not parse response"});this.options.response.headersText=a.slice(0,b.index),this.responseText=a.slice(b.index+4);var c=this.options.response.headersText.split("\r\n"),d=c.shift(),e=d.match(/(HTTP\/\d\.\d)\s+((\d+)\s+.*)/);e&&(this.status=parseInt(e[3],0),this.statusText=e[2]),c.forEach(function(a){var b=a.match(/:/);if(b){var c=a.slice(0,b.index).replace(/^\s+/g,"").replace(/\s+$/g,""),d=a.slice(b.index+1).replace(/^\s+/g,"").replace(/\s+$/g,"");this.options.response.headers[c]=d}}.bind(this)),this.processResponse()},a.prototype.processResponse=function(){if(-1!==[301,302,303,307,308].indexOf(this.status)){this.disconnect();var a=this.getResponseHeader("Location");return this.dispatchEvent("beforeredirect",a,this.options.response.headers,this.statusText),this.options.redirects.current===this.options.redirects.max?void this.error({error:"max redirects",resultCode:310}):this.options.redirects.last===a?void this.error({error:"redirect loop"}):(this.options.redirects.last=a,this.options.redirects.current++,this.open(this.options.method,a),void this.send(this.options.data))}this.readyState=this.HEADERS_RECEIVED,this.readyState=this.LOADING,this.response=this.responseText,this.readyState=this.DONE,this.dispatchEvent("progress"),this.dispatchEvent("load"),this.dispatchEvent("loadend")},a.prototype.generateMessage=function(){var a=[];a.push(this.options.method+" "+this.options.uri[4]+" HTTP/1.1");for(var b in this.options.headers)a.push(b+": "+this.options.headers[b]);return a.join("\r\n")+"\r\n\r\n"+this.options.data},a.prototype.error=function(a){var b={1:"An asynchronous IO operation is not yet complete.",2:"A generic failure occurred.",3:"An operation was aborted (due to user action)",4:"An argument to the function is incorrect.",5:"The handle or file descriptor is invalid",6:"The file or directory cannot be found",7:"An operation timed out",8:"The file is too large",9:"An unexpected error.  This may be caused by a programming mistake or an invalid assumption",10:"Permission to access a resource, other than the network, was denied",11:"The operation failed because of unimplemented functionality",12:"There were not enough resources to complete the operation",13:"Memory allocation failed",14:"The file upload failed because the file's modification time was different from the expectation",15:"The socket is not connected",16:"The file already exists",17:"The path or file name is too long",18:"Not enough room left on the disk",19:"The file has a virus",20:"The client chose to block the request",21:"The network changed",22:"The request was blocked by the URL blacklist configured by the domain administrator",23:"The socket is already connected",100:"A connection was closed (corresponding to a TCP FIN)",101:"A connection was reset (corresponding to a TCP RST)",102:"A connection attempt was refused",103:"A connection timed out as a result of not receiving an ACK for data sent. This can include a FIN packet that did not get ACK'd",104:"A connection attempt failed",105:"The host name could not be resolved",106:"The Internet connection has been lost",107:"An SSL protocol error occurred",108:"The IP address or port number is invalid (e.g., cannot connect to the IP address 0 or the port 0)",109:"The IP address is unreachable.  This usually means that there is no route to the specified host or network",110:"The server requested a client certificate for SSL client authentication",111:"A tunnel connection through the proxy could not be established",112:"No SSL protocol versions are enabled",113:"The client and server don't support a common SSL protocol version or cipher suite",114:"The server requested a renegotiation (rehandshake)",115:"The proxy requested authentication (for tunnel establishment) with an unsupported method",116:"During SSL renegotiation (rehandshake), the server sent a certificate with an error",117:"The SSL handshake failed because of a bad or missing client certificate",118:"A connection attempt timed out",119:"There are too many pending DNS resolves, so a request in the queue was aborted",120:"Failed establishing a connection to the SOCKS proxy server for a target host",121:"The SOCKS proxy server failed establishing connection to the target host because that host is unreachable",122:"The request to negotiate an alternate protocol failed",123:"The peer sent an SSL no_renegotiation alert message",124:"Winsock sometimes reports more data written than passed.  This is probably due to a broken LSP",125:"An SSL peer sent us a fatal decompression_failure alert.",126:"An SSL peer sent us a fatal bad_record_mac alert",127:"The proxy requested authentication (for tunnel establishment)",128:"A known TLS strict server didn't offer the renegotiation extension",129:"The SSL server attempted to use a weak ephemeral Diffie-Hellman key",130:"Could not create a connection to the proxy server.",131:"A mandatory proxy configuration could not be used.",133:"We've hit the max socket limit for the socket pool while preconnecting.",134:"The permission to use the SSL client certificate's private key was denied",135:"The SSL client certificate has no private key",136:"The certificate presented by the HTTPS Proxy was invalid",137:"An error occurred when trying to do a name resolution (DNS)",138:"Permission to access the network was denied.",139:"The request throttler module cancelled this request to avoid DDOS",140:"A request to create an SSL tunnel connection through the HTTPS proxy received a non-200 (OK) and non-407 (Proxy Auth) response.",141:"We were unable to sign the CertificateVerify data of an SSL client auth handshake with the client certificate's private key",142:"The message was too large for the transport",143:"A SPDY session already exists, and should be used instead of this connection",145:"Websocket protocol error.",146:"Connection was aborted for switching to another ptotocol.",147:"Returned when attempting to bind an address that is already in use",148:"An operation failed because the SSL handshake has not completed",149:"SSL peer's public key is invalid",150:"The certificate didn't match the built-in public key pins for the host name",151:"Server request for client certificate did not contain any types we support",152:"Server requested one type of cert, then requested a different type while the first was still being generated",153:"An SSL peer sent us a fatal decrypt_error alert. ",154:"There are too many pending WebSocketJob instances, so the new job was not pushed to the queue",155:"There are too many active SocketStream instances, so the new connect request was rejected",156:"The SSL server certificate changed in a renegotiation",157:"The SSL server indicated that an unnecessary TLS version fallback was performed",158:"Certificate Transparency: All Signed Certificate Timestamps failed to verify",159:"The SSL server sent us a fatal unrecognized_name alert",300:"The URL is invalid",301:"The scheme of the URL is disallowed",302:"The scheme of the URL is unknown",310:"Attempting to load an URL resulted in too many redirects",311:"Attempting to load an URL resulted in an unsafe redirect (e.g., a redirect to file: is considered unsafe)",312:"Attempting to load an URL with an unsafe port number.",320:"The server's response was invalid",321:"Error in chunked transfer encoding",322:"The server did not support the request method",323:"The response was 407 (Proxy Authentication Required), yet we did not send the request to a proxy",324:"The server closed the connection without sending any data",325:"The headers section of the response is too large",326:"The PAC requested by HTTP did not have a valid status code (non-200)",327:"The evaluation of the PAC script failed",328:"The response was 416 (Requested range not satisfiable) and the server cannot satisfy the range requested",329:"The identity used for authentication is invalid",330:"Content decoding of the response body failed",331:"An operation could not be completed because all network IO is suspended",332:"FLIP data received without receiving a SYN_REPLY on the stream",333:"Converting the response to target encoding failed",334:"The server sent an FTP directory listing in a format we do not understand",335:"Attempted use of an unknown SPDY stream id",336:"There are no supported proxies in the provided list",337:"There is a SPDY protocol error",338:"Credentials could not be established during HTTP Authentication",339:"An HTTP Authentication scheme was tried which is not supported on this machine",340:"Detecting the encoding of the response failed",341:"(GSSAPI) No Kerberos credentials were available during HTTP Authentication",342:"An unexpected, but documented, SSPI or GSSAPI status code was returned",343:"The environment was not set up correctly for authentication",344:"An undocumented SSPI or GSSAPI status code was returned",345:"The HTTP response was too big to drain",346:"The HTTP response contained multiple distinct Content-Length headers",347:"SPDY Headers have been received, but not all of them - status or version headers are missing, so we're expecting additional frames to complete them",348:"No PAC URL configuration could be retrieved from DHCP.",349:"The HTTP response contained multiple Content-Disposition headers",350:"The HTTP response contained multiple Location headers",351:"SPDY server refused the stream. Client should retry. This should never be a user-visible error",352:"SPDY server didn't respond to the PING message",353:"The request couldn't be completed on an HTTP pipeline. Client should retry",354:"The HTTP response body transferred fewer bytes than were advertised by the Content-Length header when the connection is closed",355:"The HTTP response body is transferred with Chunked-Encoding, but the terminating zero-length chunk was never sent when the connection is closed",356:"There is a QUIC protocol error",357:"The HTTP headers were truncated by an EOF",358:"The QUIC crytpo handshake failed.",359:"An https resource was requested over an insecure QUIC connection",501:"The server's response was insecure (e.g. there was a cert error)",502:"The server responded to a <keygen> with a generated client cert that we don't have the matching private key for",503:"An error adding to the OS certificate database (e.g. OS X Keychain)",800:"DNS resolver received a malformed response",801:"DNS server requires TCP",802:"DNS server failed.",803:"DNS transaction timed out",804:"The entry was not found in cache, for cache-only lookups",805:"Suffix search list rules prevent resolution of the given host name",806:"Failed to sort addresses according to RFC3484"};this.options.inprogress&&this.disconnect(),a.resultCode&&(a.resultCode=Math.abs(a.resultCode),a.message=b[Math.abs(a.resultCode)]),this.dispatchEvent("error",a)},a.prototype.disconnect=function(){this.options.inprogress=!1,null!==this.options.createInfo&&(chrome.sockets.tcp.disconnect(this.options.createInfo.socketId),chrome.sockets.tcp.close(this.options.createInfo.socketId),this.options.createInfo=null)},a.prototype.expireTimer=function(){this.readyState===this.OPENED&&(this.disconnect(),this.options.timer.expired=!0,this.error({error:"timed out"}),this.dispatchEvent("timeout"))},a.prototype.setMaxRedirects=function(a){this.options.redirects.max=a},ArrayBuffer.prototype.toString=function(a){var b=new Blob([this]),c=new FileReader;c.onload=function(b){a(b.target.result)},c.readAsText(b)},String.prototype.toArrayBuffer=function(a){var b=new Blob([this]),c=new FileReader;c.onload=function(b){a(b.target.result)},c.readAsArrayBuffer(b)}}();