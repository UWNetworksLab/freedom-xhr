/*!
 * chrome.sockets.tcp.xhr v0.0.1 (https://github.com/codeinchaos/chrome.sockets.tcp.xhr)
 * Copyright 2014 Ahmad Nassri <ahmad@codeinchaos.com> (http://ahmadnassri.com)
 * Licensed under 
 */

!function(){"use strict";var a=chrome.sockets.tcp.xhr=function(){Object.defineProperties(this,{options:{enumerable:!1,writable:!0,value:{uri:null,data:null,method:null,createInfo:null,inprogress:!1,timer:{id:null,expired:!1},headers:{Connection:"close","Accept-Encoding":"identity","Content-Length":0},response:{headers:null,responseText:null}}},props:{enumerable:!1,configurable:!1,value:{readyState:0}},timeout:{enumerable:!0,writable:!0,value:0},withCredentials:{enumerable:!0,writable:!0,value:!1},upload:{enumerable:!0,writable:!0,value:null},status:{enumerable:!0,writable:!0,value:0},statusText:{enumerable:!0,writable:!0,value:null},responseType:{enumerable:!0,writable:!0,value:""},response:{enumerable:!0,writable:!0,value:null},responseText:{enumerable:!0,writable:!0,value:null},responseXML:{enumerable:!0,writable:!0,value:null},onreadystatechange:{enumerable:!0,writable:!0,value:null},onloadstart:{enumerable:!0,writable:!0,value:null},onprogress:{enumerable:!0,writable:!0,value:null},onabort:{enumerable:!0,writable:!0,value:null},onerror:{enumerable:!0,writable:!0,value:null},onload:{enumerable:!0,writable:!0,value:null},ontimeout:{enumerable:!0,writable:!0,value:null},onloadend:{enumerable:!0,writable:!0,value:null},readyState:{enumerable:!0,get:function(){return this.props.readyState},set:function(a){this.props.readyState=a,this.onreadystatechange&&this.onreadystatechange(this.props.readyState)}}})};a.prototype.regex=new RegExp("^(?:(https?|ftp)://)(?:\\S+(?::\\S*)?@)?((?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,})))(?::(\\d{2,5}))?(/[^\\s]*)?$","i"),a.prototype.open=function(a,b){if(this.options.method=a,this.options.uri=this.regex.exec(b),!this.options.method)throw new TypeError("method is not a valid HTTP method");if(null===this.options.uri)throw new TypeError("url cannot be parsed");this.readyState=1,this.setRequestHeader("Host",this.options.uri[2])},a.prototype.setRequestHeader=function(a,b){if(1!==this.readyState||this.options.inprogress===!0)throw new TypeError("InvalidStateError");if(!a)throw new TypeError("header is not a valid HTTP header field name");if(!b&&0!==b.length)throw new TypeError("value is not a valid HTTP header field value.");this.options.headers[a]=b},a.prototype.send=function(a){var b={persistent:!1,name:"chrome.sockets.tcp.xhr"};this.options.inprogress=!0,this.options.data=a||null,chrome.sockets.tcp.create(b,this.onCreate.bind(this)),this.timeout>0&&(this.options.timer.id=setTimeout(this.expireTimer.bind(this),this.timeout))},a.prototype.abort=function(){this.disconnect()},a.prototype.getResponseHeader=function(){},a.prototype.getAllResponseHeaders=function(){return this.options.response.headers},a.prototype.overrideMimeType=function(){},a.prototype.sendAsBinary=function(){},a.prototype.onCreate=function(a){if(this.options.inprogress){var b=this.options.uri[3]?this.options.uri[3]:80;this.options.createInfo=a,chrome.sockets.tcp.connect(a.socketId,this.options.uri[2],parseInt(b,null),this.onConnect.bind(this))}},a.prototype.onConnect=function(a){this.options.inprogress&&(this.options.timer.expired||(0>a?this.error({error:"connection error",code:a}):(chrome.sockets.tcp.onReceive.addListener(this.onReceive.bind(this)),this.getMessage().toArrayBuffer(function(a){chrome.sockets.tcp.send(this.options.createInfo.socketId,a,this.onSend.bind(this))}.bind(this)))))},a.prototype.onReceive=function(a){this.options.inprogress&&a.socketId===this.options.createInfo.socketId&&(this.disconnect(),a.data.toString(function(a){var b=a.match(/\r\n\r\n/);this.options.response.headers=a.slice(0,b.index),this.readyState=2,this.options.response.responseText=a.slice(b.index+4),this.responseText=this.options.response.responseText,this.readyState=3,this.response=this.responseText,this.readyState=4}.bind(this)))},a.prototype.getMessage=function(){var a=[];a.push(this.options.method+" "+this.options.uri[4]+" HTTP/1.1");for(var b in this.options.headers)a.push(b+": "+this.options.headers[b]);return a.join("\r\n")+"\r\n\r\n"+this.options.data},a.prototype.error=function(a){this.options.inprogress&&this.disconnect(),this.onerror&&this.onerror(a)},a.prototype.disconnect=function(){this.options.inprogress=!1,null!==this.options.createInfo&&(chrome.sockets.tcp.disconnect(this.options.createInfo.socketId),chrome.sockets.tcp.close(this.options.createInfo.socketId),this.options.createInfo=null)},a.prototype.expireTimer=function(){null===this.responseText&&(this.disconnect(),this.options.timer.expired=!0,this.error({error:"timeout"}),this.ontimeout&&this.ontimeout())},a.prototype.onSend=function(a){a.resultCode<0&&(this.error({error:"sending error"}),this.disconnect())},ArrayBuffer.prototype.toString=function(a){var b=new Blob([this]),c=new FileReader;c.onload=function(b){a(b.target.result)},c.readAsText(b)},String.prototype.toArrayBuffer=function(a){var b=new Blob([this]),c=new FileReader;c.onload=function(b){a(b.target.result)},c.readAsArrayBuffer(b)}}();